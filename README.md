# Multitasking in NodeJS
This repository contains code which can be used to compare the performance of multi-threading and multi-processing in nodeJS.
##### _Requirements:_
- NodeJS and npm
- postgreSQL
- JMeter

## Running the code
- Clone the repository.
- Create a database called _student_. (See the ormconfig.json file for more configuration details)
- Import the data from the _student.sql_ file of the repository. (Or [do this](#generate-student-data))
- Open up a terminal, cd into the root directory of the repository and install all dependencies:
```sh
cd multitasking-nodeJS
npm i
```
#### Modes of execution
The code is meant to provide an **express** server which does a time-consuming synchronous task: calculating percentile for students of the database. The route-handler of the route `/percentile` calculates the percentile with the help of nested loops.

##### Run in sigle-threaded mode
Run the following command to start the server in single-threaded mode:
```sh
node src/app.js
```
In single-threaded mode, the JS code is executed synchronously. It is time consuming when there are long-running JS code as it results in blocking of the event loop.

##### Run in multi-threaded mode
Run the following command to start the server in multi-threaded mode:
```sh
node src/thread-app.js
```
In multi-threaded mode, the JS code can be run asynchronously in multiple threads using the nodeJS module `worker_threads`. Workers (threads) are useful for performing CPU-intensive JavaScript operations. They will not help much with I/O-intensive work. Node.jsâ€™s built-in asynchronous I/O operations are more efficient than Workers can be [(reference)](https://nodejs.org/dist/latest-v14.x/docs/api/worker_threads.html#:~:text=Workers%20(threads)%20are%20useful%20for%20performing%20CPU-intensive%20JavaScript%20operations.%20They%20will%20not%20help%20much%20with%20I/O-intensive%20work.%20Node.js%E2%80%99s%20built-in%20asynchronous%20I/O%20operations%20are%20more%20efficient%20than%20Workers%20can%20be.).

##### Run in multiple processes
To run the server in multiple processes, do the following:
In Windows, run the command:
```sh
.\node_modules\.bin\pm2 start src/app.js -i max
```
In Mac or Linux, run the command:
```sh
./node_modules/.bin/pm2 start src/app.js -i max
```
> **Note**: execute `.\node_modules\.bin\pm2 delete all` command to stop and delete the processes generated by pm2

#### Testing the results
Once the server has been turned on in one of the modes, the results can be seen by visiting the link `http://localhost:3000/` in the browser. The browser sends 4 AJAX requests simultaneouly to the same route: `http://localhost:3000/percentile`. It will be evident quickly that the response time is lowest for the multi-threaded mode, while the single-threaded mode has the highest response time.

##### JMeter
For more robust performance testing, the three modes of execution can be compared using **JMeter**.
To run JMeter, do the following:
- In the bin folder of JMeter's directory, find the file to open the JMeter GUI. In windows, it is the jmeter.bat file.
- Go to file --> open in the JMeter GUI:![alt text for screen readers](https://raw.githubusercontent.com/BikashBrigosha/multitasking-nodeJS/main/public/images/Screenshot%20(8).png)
- Open the file 'nodejs thread group.jmx' in the root directory of the local repository:![alt text for screen readers](https://raw.githubusercontent.com/BikashBrigosha/multitasking-nodeJS/main/public/images/Screenshot%20(9).png)
- Expand 'Thread Group' and 'HTTP Request' and select 'View Results in Table'![alt text for screen readers](https://raw.githubusercontent.com/BikashBrigosha/multitasking-nodeJS/main/public/images/Screenshot%20(10).png)
- Click the run button to see the results.![alt text for screen readers](https://raw.githubusercontent.com/BikashBrigosha/multitasking-nodeJS/main/public/images/Screenshot%20(11).png)

Run the server in each mode and test the results. 
### *generate student data
Run the express server:
```sh
cd multitasking-nodeJS
node src/app.js
```
Visit the link `http://localhost:3000/generate-random` in the browser and the database will be seeded with random values.
## References
While doing this research, the following articles were referred to:
- ([Node.js multithreading: What are Worker threads, and why do they matter?](https://blog.logrocket.com/node-js-multithreading-what-are-worker-threads-and-why-do-they-matter-48ab102f8b10/)) It is mentioned [here](https://blog.logrocket.com/node-js-multithreading-what-are-worker-threads-and-why-do-they-matter-48ab102f8b10/#:~:text=Also%2C%20keep%20in,own%20pool%20implementation.) in this article that a worker_thread is still very heavyweight and it is not recommended to create one in runtime. So, in this research, a pool of worker_threads is created when the server is started.
- For creating a pool of worker_threads, the npm library [node-worker-threads-pool](https://www.npmjs.com/package/node-worker-threads-pool) is used.
- [Why use SharedArrayBuffer](https://stackoverflow.com/questions/63224356/is-node-js-considered-multithreading-with-worker-threads#:~:text=Now%2C%20I%20could%20have%20also%20used%20child%20processes%20for%20this%2C%20but%20they%20would%20have%20been%20less%20efficient%20because%20I%20needed%20to%20pass%20large%20buffers%20of%20data%20between%20the%20main%20thread%20and%20a%20workerThread)
- [multiple threads vs fork-processes in NodeJS](https://github.com/nodejs/help/issues/1920)
- [Another nice article which shows how to use SharedArrayBuffer and Atomics](https://livecodestream.dev/post/how-to-work-with-worker-threads-in-nodejs/)
- [One ExpressJS best practice](https://expressjs.com/en/advanced/best-practice-performance.html#run-your-app-in-a-cluster). pm2 is used in this research for the clustering (multiple processes).
